<!DOCTYPE html>
<html lang="en">
<head>
    <script>
        if(!location.hash.replace('#', '').length) {
            location.href = location.href.split('#')[0] + '#' + (Math.random() * 100).toString().replace('.', '');
            location.reload();
        }
    </script>

    <title>WebRTC One-to-Many Video-Broadcasting | Muaz Khan</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <link rel="author" type="text/html" href="https://plus.google.com/100325991024054712503">
    <meta name="author" content="Muaz Khan">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <script>
        var hash = window.location.hash.replace('#', '');
        if (!hash.length) location.href = location.href + '#meeting-roomid-' + ((Math.random() * new Date().getTime()).toString(36).toLowerCase().replace(/\./g, '-'));
    </script>
    <script src="https://cdn.webrtc-experiment.com/socket.io.js"></script>
    <script src="lib/meeting.js"> </script>
    <link rel="stylesheet" type="text/css" href="lib/videoCSS.css">
</head>
<body>


<section class="plusone-gplus">
    <div class="g-plusone" data-href="https://www.webrtc-experiment.com/"></div>
</section>
<section id="tips">
    <h2>Setup a new interview:</h2>

    <button id="setup-new-meeting">Setup New interview</button>
</section>


<div id="videos-container" class="videoContainer"></div>
<div id="browser-tips" class="right-top"></div>
<script>
    if(verbose == -2)
        alert(window.location.hash);
    var hash = window.location.hash.replace('#', '');
    var sections = hash.split('?');
    var meeting = new Meeting(hash);

    hash = sections[0];
    if(verbose == -2)
        alert(hash);

    var videoContainer = document.getElementById('videos-container');
    var channel = location.href.replace(/\/|:|#|%|\.|\[|\]/g, '');
    var sender = Math.round(Math.random() * 999999999) + 999999999;
	channel = channel.split('?')[0];
    
    var SIGNALING_SERVER = 'https://webrtcweb.com:9559/';
    io.connect(SIGNALING_SERVER).emit('new-channel', {
        channel: channel,
        sender: sender
    });

    var socket = io.connect(SIGNALING_SERVER + channel);
    socket.on('connect', function () {
        // setup peer connection & pass socket object over the constructor!
    });
    socket.send = function (message) {
        socket.emit('message', {
            sender: sender,
            data: message
        });
    };
    meeting.openSignalingChannel = function(callback) {
        return socket.on('message', callback);
    };
    // on getting media stream
    meeting.onaddstream = function(e) {

        //alert("stream added");
        var newVideo = e.video;
        e.video.setAttribute("controls",true);
        e.video.setAttribute("playsinline",'');

        videoContainer.appendChild(e.video);
        if(e.video.id == "remoteStream")
            switchClass();
    };
    // using firebase for signaling
    meeting.firebase = 'rtcweb';
    // if someone leaves; just remove his video
    meeting.onuserleft = function(userid) {
        var video = document.getElementById(userid);
        if (video) video.parentNode.removeChild(video);
    };
    // check pre-created meeting rooms
    meeting.check();
    document.getElementById('setup-new-meeting').onclick = function() {
        // setup new meeting room
        meeting.setup('meeting room name');
        this.disabled = true;
        this.parentNode.innerHTML = '<h2><a href="' + location.href + '" target="_blank">Share this link</a></h2>';
    };

    //judge browser and give tips
    var u = navigator.userAgent;
    var isAndroid = u.indexOf('Android') > -1 || u.indexOf('Adr') > -1;
    var isiOS = !!u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/);
    var p = document.createElement("p");
    if(isiOS)
        p.innerHTML = "Please open in Safari 11";
    else
        p.innerHTML = "Please open in Chrome";
    document.getElementById("browser-tips").appendChild(p);

</script>

<script src="https://cdn.webrtc-experiment.com/common.js"> </script>
</body>
</html>